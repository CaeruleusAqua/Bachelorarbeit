\documentclass[11pt,twoside,a4paper,openright]{mpreport}
\usepackage[utf8]{inputenc}
\usepackage[ngerman]{babel}
%\usepackage{a4wide}
%\usepackage[T1]{fontenc}
%\usepackage{textcomp}
%\usepackage{mathptmx}
\usepackage[scaled=0.85]{helvet}
%\usepackage{courier}           % if you really want to use Courier
%\usepackage{url}
\usepackage{cite}
\usepackage{tabularx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[ 
   colorlinks,        % Links ohne Umrandungen in zu wählender Farbe 
   linkcolor=black,   % Farbe interner Verweise 
   filecolor=black,   % Farbe externer Verweise 
   citecolor=black    % Farbe von Zitaten 
]{hyperref}
\usepackage{ngerman}
\usepackage{textcomp}
\usepackage{wdok-title}
\usepackage{tikz,pgfplots}
\usepackage[section]{placeins} 
\usepackage{here} 
\usetikzlibrary{patterns}
\usetikzlibrary{fpu}
%%\usepackage[pdf]{pstricks}
\setlength{\parindent}{0pt}
\newcommand{\arcosh}{\mbox{arcosh }}
%\pgfplotsset{compat=1.8}
\definecolor{lila}{rgb}{0,0.2,0.8}

% Examples for the definition of convenience commands
\newcommand{\package}[1]{\texttt{#1}}
\newcommand{\foreign}[1]{\emph{#1}}
\newcommand{\q}[1]{»#1«}

% Scale Courier by 0.9
% cf. <http://groups.google.de/groups?selm=yfid76obspu.fsf@triumf.ca>
%\DeclareFontFamily{T1}{pcr}{}
%\DeclareFontShape{T1}{pcr}{m}{n}{
%   <-> s*[.9]pcrr8t
%}{}

\title{Hardware/Software Codesign}
\author{Julian-Benedikt Scholle}
\supervisor{Dr. Ing. Sebastian Zug\\
  Dipl.-Inform Christoph Steup}

\begin{document}
\maketitle
\tableofcontents

\chapter{Einleitung}

\chapter{Anforderungsanalyse} Anforderungsanalyse
\subsection{Anforderungen an die Platine}
Laut Regelwerk sind alle Teams zur verwendung eines elektrischen Antriebs verpflichtet.
Die Anzahl der angetriebenen Räder ist nicht vorgeschrieben
des weiteren muss das Auto durch Akkus mit Strom versorgt werden.
Die Übertragung von Daten ist während der Dauer der Disziplinen nicht gestattet

\subsubsection{Fahrzeugabmessungen}
Es ist ein vierrädriges Fahrzeug mit 2 Achsen im Maststab 1:10 vorzusehen. Die Spurweite, gemessen von Reifenmitte zu
Reifenmitte, muss mindestens 16 cm betragen. Der Radstand muss mindestens 20 cm betragen.
Die Höhe des Fahrzeuges darf 30 cm nicht überschreiten, über das Fahrzeug hinausragende flexible Antennen sind gestattet.
Zur Abnahme des Fahrzeuges, muss es durch ein 40 cm Breites und 30 cm Hohes Tor fahren.


\subsubsection{RC-Modus}
In Notsituationen muss es möglich sein das Fahrzeug mit Hilfe einer Funkfernbedienung anzuhalten und manuell zu steuern. Eine solche Notsituation tritt ein, wenn
das Auto seine Aufgabe aufgrund eines Fahrfehlers oder anderem Fehlverhalten nicht mehr autonom fortführen kann.
Der RC-Modus muss per Fernbedienung eingeschaltet und ausgeschaltet werden, bei Aktivierung des RC-Modus muss das Fahrzeug unverzüglich angehalten werden.
Während des Wettbewerbs darf die Geschwindigkeit des Autos $0,3\frac{m}{s}$ nicht überschreiten.
Da das 2,4-GHz Band bereits durch die Vorort genutzte Kameratechnik belegt ist können diese Frequenzen nicht für den RC-Modus genutzt werden.
Der RC-Modus muss durch eine blaue Leuchte an der höchsten stelle des Fahrzeuges angezeigt werden, welche mit einer Frequenz von 1-Hz blinkt.

\subsubsection{Signalleuchten}
Durch die Anlehnung des Wettbewerbes an den realen Straßenverkehr muss das Auto über alle in echten Auto vorhandene Signalleuchten besitzen. 
Dazu gehören 3 rote Bremslichter am Heck des Autos sowie jeweils 2 gelbe Blinker Rechts und Links am Fahrzeug.  Die Blinkfrequenz der Blinker muss
1-Hz betragen.

\subsubsection{Verkleidung}
Um eine schnelle Wartung und Überprüfung zu ermöglichen muss die Fahrzeug Abdeckung jederzeit schnell und einfach entfernt werden können. Des Weiterem muss die dem 
Schutzgrad IP 11 entsprechen.


\subsection{Resultat aus den Anforderungen}
Aufgrund der Anforderungen der elektrischen Antriebes und des Maststabes von 1:10 kann als Grundaufbau des Autos ein gängiges Ferngesteuertes Auto aus dem
freien Handel genutzt werden. Die zur Verfügung stehenden Möglichkeiten wurden dabei im Team diskutiert und die Wahl fiel dabei auf das ``TT-01R Type E'' welches
allen Anforderungen genügt. Tamiya ist seit langen ein im Modellbau etablierter Hersteller so das hier Ersatzteile lange verfügbar sein sollten.

Im Bausatz des TT-01R Type E ist bereits ein Elektromotor samt Reglerelektronik enthalten. Leider verbaut Tamiya Motoren von vielen verschiedenen Herstellern,
zu denen es leider kein Datenblatt gibt. Einige Recherchen ergaben allerdings das alle Motoren Nachbauten eines ``Mabuchi RS-540SH'' sind, von welchem ein Datenblatt
existiert \cite{Mabuchi}








\chapter{Stand der Technik}

\chapter{Motorstrommessung am Shunt}


\section{Problem}

An einem mit PWM angesteuertem DC-Motor soll eine Strommessung mit Hilfe eines Shuntwiderstandes
durchgeführt werden. Aufgrund der PWM Ansteuerung muss der DC-Anteil aus dem Signal herausgefiltert werden!


\section{Prinzip der Strommessung}

Die Messspannung wird über einen Shuntwiderstand zur Masse gemmessen! Aufgrund nicht vorhandener Datenblätter des Motors
wird von einem Expirimentel Ermittelten maximalen Strom des Motors ausgagangen. Dieser beträgt bei einer Betriebsspannung von 20V ca. 20A.
Da einen Shunt mit einer maximalen Belastbarkeit von 2 Watt eingesetzt wird, darf der maximale Spannungsabfall am Shunt 100mV nicht überschreiten.
Nach dem Ohmschen gesetz ergib sich dadurch ein Widerstand von $0,005 \Omega$  für den Shunt. Shuntwiderstände in der Größe sind problemlos zu bekommen.
Da es sich hir um eine Worst Case Rechnung handelt, wird der zusätliche Widerstand des Shuntwiderstandes und der damit verringerte Strom bewust ignoriert.

Die über den Shuntwiderstand gemessene Spannung soll über den ADC Eingang des Mikrocontrollers eingelesen werden. Vorher jedoch muss das Signal gefiltert werden, da der Strom
durch die Ansteuerung mittels der Pulsweitenmodulation nicht konstant ist!



\section{Anforderungen}
Die maximale Auflösung des Mikrocontrollers soll ausgenutzt werden. Der ADC des Mikrocontrollers arbeitet mit einer Auflösung von 10 Bit und einer 
Referenzspannung von 5V. Um die Auflösung des ADC auszunutzen muss das Signal, aufgrund unseres Spannungsabfalls verstärkt werden.

Als Anforderung ergibt sich außerdem, dass der maximale Ripple des Endsignals kleiner ist als der Quantisierungsfehler des ADC.
So ist es möglich aufeine zusätzliche Digitale Filterung weitgehend zu verzichten.
Die Kleistmöglkiche zu erfassende Spannung des ADC beträgt $\frac{5}{2^{10}}=4,88mV$.
Diesen wert sollte der Ripple des Endsignales nicht überschreiten.
Aus einem möglichst kleinem Ripple resultiert eine möglichst hohe Filterordnung bzw. eine niedrige Grenzfrequenz.
Allerdings soll $U_{DC}$ einer Änderung des Mittelwertes, also einer Änderung des Tastverhältnisses, möglichst
schnell folgen. Diese Anforderung widerspricht der Voherigen so das ein Kompromiss gefunden werden muss.

\section{Bestimmung des Filtertyps}
Aufgrund des sehr nidrigen Spannungpegels am Shunt,ist es nötig das Signal zu verstärken. Da zum verstärken des Signals aktive elektronische elemente notwendig sind,
z.B. ein Operationsverstärker, wird an dieser Stelle gleich ein aktiver Filter verwedet. Dieser gibt uns die Möglichkeit des Messignal zu verstärken und gleichzeitig zu
Filtern. Da wir als unser Signal im optimalen Fall eine Gleichspannung darstellt müssen wir die Hochfrequenten anteile unseres Signales herausfiltern, dies geschieht 
mit Hilfe eines Tiefpasses. Es gibt im Grunde 2 übliche aktive Tiefpässe, den Tiefpass mit Mehrfachgegenkopplung und den Sallen-Key Filter. Ersterer verwendet
einen invertierenden Verstärker, dieser invertiert das Messsignal. Da der µController jedoch nur mit Postitiven Spannungen umgehen kann müsste mann hier mit einer 
negativen Referenzspannung Arbeiten, was den Schaltungsaufwand unnötig vergrößern würde. Der Sallen-Key Tiefpass benutzt einen nicht invertierenden Verstärker, welcher diesen
Nachteil nicht hat. So das ab dieser Stelle ein Sallen-Key Tiefpass entwurfen wird.


\section{Die Filterschaltung}
\begin{figure}[H]
\centering
\includegraphics[width=.8\textwidth]{filter_schaltung.png}\\
\caption{Spannung am Shunt + PWM}%
\label{fig:pwm+i}
\end{figure}



\section{Dimensionierung des Verstärkers}

In bisherigen Rechnungen wurde ein maximaler Spannungsabfall von 100mV am Shunt errechnet. Da der Messbereich des voll ADC ausgenutzt werden soll,
ist es nötig das Messignal zu verstärken. Hierzu wir ein Nichtinvertierender Verstärker benutzt. Da der Messbereich des ADC bis 5V reicht, wird hier eine 
50 fache Verstärkung angestrebt.

Für einem Nichtinvertierenden Verstärker ergibt sich dann:

\begin{align*}
v &= 1 + \frac{R_2}{R_1}\\
50 &= 1 + \frac{R_2}{R_1}\\
49\cdot R_1 &= R_2
\end{align*}
\\
Wobei $R_1 = 47 k\Omega$ und $R_2 = 1 k\Omega$  gewählt werden, was eine Verstärkung von 48 ergibt.



\section{Anforderungen an den Filter}

\begin{figure}[H]
\centering
\includegraphics[width=.8\textwidth]{oszi.png}\\
\caption{Spannung am Shunt + PWM}%
\label{fig:pwm+i}
\end{figure}

Da dem Messsignal wie in Abbildung \ref{fig:pwm+i} zu erkennen, die PWM Frequenz zu Grunde liegt wird sich bei der Dimensionierung des Filters einer Idee nach \cite{Alter2008} bedient, nach der die maximale Amplitude des Ripple der Grundschwingung bei einem
Tastverhältnis von 0,5 entspricht. Die Amplitude der Grunschwingung ergibt sich aus dem ersten Koeffizienten der Fouerreihe einer Rechteckschwingung.
\begin{align}
A_1 = K\cdot \frac{1}{\pi}[\sin(\pi p)-\sin(2\pi(1-\frac{p}{2}))]
\label{eq:ripple}
\end{align}
Wobei p dem Tastverhältnis und K der maximale Amplitude des Ursprungsingals entspricht \cite{Alter2008}. K entspricht den erechneten 100mV multipliziert mit dem Verstärkungsfaktor 48, also 4,8V und p wird zu 0,5
angenommen. Mit (\ref{eq:ripple}) ergibt sich für die Amplitude der Grundschwingung $ A_1 = K\cdot \frac{2}{\pi} = 3,056V$. $A_1$ soll auf $ < 4,88mV$ gedämpft werden.
Als Sperrfrequenz $\Omega_s $ wird hier die PWM Frequenz angesetzt für $H(\omega=2\pi f_{PWM})$ gilt also:

\begin{align}
H(\omega=2\pi f_{PWM}) \le \frac{4,88mV}{3,056V} \mathop{\hat{=}} 20\cdot\log(\frac{4,88mV}{3,056V})= -55,9 dB
\label{eq:daempfung}
\end{align}

Da das Projekt möglicht kostensparend durchgeführt werden soll, also auch Bauteilsparend, wird an dieser Stelle von den üblichen Konventionen zur dimensionierung von Filtern abgewichen.
Statt eine fixe Grenzfreqeunz festzulegen und die benötigte Filterordnung zu bestimmen, wird die Filterordnung vorgegeben und die Grenzfrequenz variert.

\section{Filterentwurf}

\subsection{Bestimmung des Filtertyps}

Des Filtertyp muss in Zweierlei hinblich bestimmt werden. Einmal im hinblich auf die Schaltung und seinem Frequenzgang.
Im groben gibt es 2 mögliche Tiefpassfilterschaltungen, den Sallen-Key Teifpass mit nicht invertierendem OPV und dem aktiven Tiefpass mit Mehrfachgegenkopplung 
(invertierender OPV). Der aktive Tiefpass mit Mehrfachgegenkopplung benotigt allerdings negative Spannungsniveaus die auf der Treiberplatine nicht zur
verfügung stehen, desshalb wird an dieser Stelle nur der Sallen-Key Teifpass behandelt.
Was den Frequenzgang angeht gibt es viele Filtercharakteristiken, eine Auswahl an haufig verwendeten Charakteristiken wird hier verglichen.

\begin{tabular}{p{0.2\textwidth}p{0.2\textwidth}p{0.2\textwidth}p{0.2\textwidth}}
 Filtercharakteristik & Eigenschaften & Vorteile & Nachteile \\
Butterworth-Filter & Maximal flacher Verlauf des Betragsfrequenzganges im Durchlassbereich, Dämpfung im Sperrbereich monoton verlaufend& Gutes Amplitudenverhalten im Durchlass- und Sperrbereich & Geringe Flankensteilheit im Übergangsbereich 
\end{tabular}




\begin{figure}[H]
\centering
\begin{tikzpicture}
	\draw[->,thick] (0,0) -- (7.5,0) node[right] {$f[\text{Hz}]$};
	\draw[->,thick] (0,0) -- (0,3.3) node[above] {$a[\text{dB}]$};
	\draw (0,2.5)node[left] {$a_{\text{min}}$} (-0.1,2.5)--(2.9,2.5);
	\draw (0,1)node[left] {$a_{\text{max}}$};
	\def \bsp{(0,1)--(1,1)--(1,2.4)--(1,2.4)--(0,2.4)}
	\draw (-0.1,1)--(1,1)--(1,2.4) (1,0)node[below] {$f_g$};
	\pattern[pattern=north east lines] \bsp;
	\draw[dashed] (1,1) -- (1,-0.1);
	\def \bsd{(3,0) -- (3,2.5) -- (7,2.5) -- (7,0)}
	\pattern[pattern=north east lines] \bsd;
	\draw (3,0)node[below] {$f_s$} -- (3,2.5) -- (7,2.5);

\end{tikzpicture}
\caption{Tiefpass Toleranzfeld}%
\label{fig:analog}
\end{figure}
Für unsere Schaltung wird ein Sallen Key Tiefpass 2. Ordnung entwurfen. Die PWM-Frequenz $f_{PWM}$ beträt 3,9kHz.
Die Sperrfrequenz entspreicht der PWM Frequenz, also der Frequenz unserer Grundschwingung. $\Omega$ entspricht der mit der Grenzfreqeunz 
normierten Frequenz $\Omega=\frac{f}{f_g}$. Nach (\ref{eq:daempfung}) ergibt sich für Abbildung \ref{fig:analog}
$f_s=f_{PWM}=3,9 kHz$, $a_{min}=55,9 dB$ und $a_{max}$ wird auf 3dB festgelegt.



\subsection{Butterworth}
\subsection{Bestimmung der Grenzfreqeunz}
\begin{align}
n \ge \frac{\log{\sqrt{\frac{e^{2a_{min}}-1}{e^{2a_{max}}-1}}}}{\log{\Omega_s}}
\label{eq:butterworth}
\end{align}
Die Filterordnung nach Butterworth wird nach (\ref{eq:butterworth}) bestimmt. Umgestellt nach $\Omega_s$ ergibt sich:

\begin{align}
\Omega_s \le  \left(\frac{e^{2a_{min}}-1}{e^{2a_{max}}-1}\right)^{\frac{1}{2n}}
\end{align}



Für die Berechnung der Sperrfrequenz $\Omega_s$ müssen  $a_{min}$ und $a_{max}$ in Neper umgrechnet werden. Wobei:
\begin{align*}
1 \text{dB} =  \frac{\ln{10}}{20}\text{Np} = 0,115129255 \text{Np}   
\end{align*}

Damit ergibt sich für $a_{min}=55,9 dB\cdot \frac{\ln{10}}{20}=6,45Np$ und für  $a_{max}=3 dB\cdot \frac{\ln{10}}{20}=0,345Np$. Die Filterordnung wird auf 2 festgelegt.
\begin{align}
\Omega_s \le  \left(\frac{e^{2\cdot6,45N }-1}{e^{2\cdot 0,345Np}-1}\right)^{\frac{1}{2n}}  = 35,8
\end{align}

Die Grenzfreqeunz $f_g$ ergibt sich jetzt aus:

\begin{align}
\frac{f_s}{\Omega_s} \le \frac{3,9kHz}{25,19} = 154,8Hz
\end{align}

\subsubsection{Filterentwurf}
Im voherigen Abschnitt wurde berechnet das die Grenzfreqeunz der Filters kleiner als 154,8Hz sein muss.
Im Folgenden wird nun ein Sallen-Key Filter 2. Ordnung mit einer Grenzfrequenz von 150Hz entwurfen.


\subsubsection{Finaler Entwurf}



Betrachetn wir das Polstellen-Nullstellendiagramm eines Butterworth Filters 2. Ordnung.

\begin{tikzpicture}
	\draw[->,thick] (-3,0) -- (3,0) node[right] {$\text{Re}$};
	\draw[->,thick] (0,-3) -- (0,3) node[above] {$\text{Im}$};
	\draw[dashed,red,very thin] (-3,2) -- (3,2);
	\draw[dashed,red,very thin] (-3,-2) -- (3,-2);
	\draw[dashed,red,very thin] (2,-3) -- (2,3);
	\draw[dashed,red,very thin] (-2,-3) -- (-2,3);
	\draw[dashed,blue,very thin] (0,0) circle (2);
	\coordinate (x) at (225:2); 
	\coordinate (y) at (135:2);
	\draw[very thin] (0,0) -- (y);
	\draw[red,thick] (x) -- +(0.1,0.1)  (x) -- +(-0.1,-0.1) (x) -- +(0.1,-0.1) (x) -- +(-0.1,0.1);
	\draw[red,thick] (y) -- +(0.1,0.1)  (y) -- +(-0.1,-0.1) (y) -- +(0.1,-0.1) (y) -- +(-0.1,0.1);
	\draw (2,0)node[below] {$1$};
	\draw (-2,0)node[below] {$-1$};
	\draw (0,2)node[left] {$1$};
	\draw (0,-2)node[left] {$-1$};
	\draw (0,-2)node[left] {$-1$};
	\draw (0,0) (135:1cm) arc (135:180:1cm);
	\draw (-0.6,0.3)node {$\delta$};
\end{tikzpicture}

Charakteristisch für den Butterworthfilter ist das sich die Polstellen auf einer Kreisbahn befinden. Auf die Grenzfreqeunz normiert hat dieser beim Butterworthfilter den Radius
eins. Bei einem Butterworth 2. Ordnung befinden sie sich genau bei $\delta=45^\circ$. Das Interessante am Polstellen-Nullstellendiagramm ist, dass sich Polfrequenz $\Omega_P$ und 
Polgüte $Q_P$ einfach ablesen lassen. Die Polfrequenz $\Omega_P$ ist der Betrag der normierten Polstelle, welche beim Butterworth immer eins ist.
Die Polgüte ist abhängig von $\delta$ und ergibt sich zu: $Q_P=\frac{1}{2\cos{\delta}}$. Für unseren Butterworthfilter ergeben sich also $Q_P=0,707$ und $\Omega_P=1$


Übertragungsfunktion eines Sallen-key Teifpasses
\begin{align*}
A(P)&=\frac{A_0}{1+\omega_g (R_2 C_2 + R_1 C_2 + R_1 C_2(1-A_0))P + \omega_g^2R_1 R_2 C_1C_2P^2}
\end{align*}

mit
\begin{align*}
A_0=\frac{R_6}{R_5}-1
\end{align*}


Die Bauteilwerte erhält man durch einen Koeffizientenvergleich mit der entnormierten
Übertragungsfunktion eines Tiefpasses zweiter Ordnung:

\begin{align*}
A(P)&=\frac{A_0}{1+\frac{1}{\omega_g\Omega_PQ_P}s+\frac{1}{\omega_g^2\Omega_P^2}s^2}
\end{align*}

nach den Koeffizientenvergleich ergibt sich

\begin{align*}
C_1<\frac{C_2*(1+4Q^2_P(A_0-1))}{4Q^2_P}
\end{align*}

\begin{align*}
R_1=\frac{1}{2\omega_g\Omega_PQ_P} \cdot \frac{C_2+\sqrt{C_2^2-4Q^2_PC_2(C_1+C2(1-A_0))}}{C_2(C_1-C_2(A-0_1))}           
\end{align*}


\begin{align*}
R_2=\frac{1}{2\omega_g\Omega_PQ_P} \cdot \frac{C_2+\sqrt{C_2^2-4Q^2_PC_2(C_1+C2(1-A_0))}}{C_1C_2}           
\end{align*}


\begin{align*}
Q_p=\frac{\sqrt{R_1R_2C_1C_2}}{C1(R_1+R_2)+R_1C_2(1-A_0)}
\end{align*}

\begin{align*}
\Omega_p=\frac{1}{\omega_g\sqrt{R_1R_2C_1C_2}}
\end{align*}


\begin{tikzpicture}
	\draw[->,thick] (-3,0) -- (3,0) node[right] {$\text{Re}$};
	\draw[->,thick] (0,-3) -- (0,3) node[above] {$\text{Im}$};
	\draw[dashed,red,very thin] (-3,2) -- (3,2);
	\draw[dashed,red,very thin] (-3,-2) -- (3,-2);
	\draw[dashed,red,very thin] (2,-3) -- (2,3);
	\draw[dashed,red,very thin] (-2,-3) -- (-2,3);
	\draw[dashed,blue,very thin] (0,0) circle (2);
	\coordinate (x) at (225:2); 
	\coordinate (y) at (135:2);
	\draw[very thin] (0,0) -- (y);
	\draw[red,thick] (x) -- +(0.1,0.1)  (x) -- +(-0.1,-0.1) (x) -- +(0.1,-0.1) (x) -- +(-0.1,0.1);
	\draw[red,thick] (y) -- +(0.1,0.1)  (y) -- +(-0.1,-0.1) (y) -- +(0.1,-0.1) (y) -- +(-0.1,0.1);
	\draw (2,0)node[below] {$1$};
	\draw (-2,0)node[below] {$-1$};
	\draw (0,2)node[left] {$1$};
	\draw (0,-2)node[left] {$-1$};
	\draw (0,-2)node[left] {$-1$};
	\draw (0,0) (135:1cm) arc (135:180:1cm);
	\draw (-0.6,0.3)node {$\delta$};
\end{tikzpicture}



\bibliography{BIB}{}
\bibliographystyle{plain}

\end{document}